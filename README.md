# Disabled_RGA2_OrangePi5Ultra
## Инструкция по отключению RGA2 в Orange pi 5 Ultra
#### Данная инструкция предназначена для решения проблемы с аппаратным ускорителем 2D-графики RGA.
#### В процессоре RK3588 имеется два типа аппаратных ускорителей 2D-графики. Это RGA2 и RGA3.
### **Отличия аппаратных ускорителей RGA2 и RGA3 в RK3588**  

#### **1. Разница в архитектуре и количестве ядер**  
- **RGA2** – одноядерный ускоритель, унаследованный от предыдущих чипов Rockchip (например, RK3399).  
  - **Одно ядро** → ограниченная параллельная обработка, ниже производительность.  
  - Оптимизирован для базовых операций: масштабирование, поворот, альфа-смешивание.  
- **RGA3** – двухъядерный, более современный блок.  
  - **Два ядра** → выше параллелизм, лучше справляется с сложными задачами (например, одновременная обработка нескольких потоков видео).  
  - Добавлены новые функции: бикубическое масштабирование, 10-битные форматы, улучшенная работа с HDR.  

#### **2. Ограничение памяти RGA2 (4 ГБ)**  
RGA2 не поддерживает адресацию памяти **свыше 4 ГБ** из-за:  
- **32-битной адресации** – старый дизайн, унаследованный от предыдущих поколений.  
- **Ограничения DMA (Direct Memory Access)** – RGA2 использует 32-битные регистры для работы с памятью, что не позволяет обращаться к адресам выше `0xFFFFFFFF` (4 ГБ).  
- **Совместимость** – RGA2 изначально проектировался для систем с небольшим объемом ОЗУ (например, в RK3398/RK3399 обычно стоит ≤4 ГБ).  

#### **3. RGA3 поддерживает >4 ГБ благодаря 64-битной адресации**  
- Использует **64-битные DMA-регистры**, что позволяет работать с большими буферами.  
- Оптимизирован для современных задач (например, обработка 4K/8K видео с высоким разрешением).  

### **Почему в RK3588 оставили RGA2, если есть RGA3?**  
1. **Совместимость** – старые приложения и драйверы могут задействовать RGA2.  
2. **Распределение нагрузки** – простые задачи (например, UI-рендеринг) можно отдать RGA2, а сложные (видео, CV) – RGA3.  
3. **Энергоэффективность** – для несложных операций RGA2 может потреблять меньше энергии.  

### **Вывод**  
- **RGA3** – более мощный (2 ядра, 64-битная адресация, новые форматы).  
- **RGA2** – оставлен для совместимости, но ограничен 4 ГБ ОЗУ и 32-битной адресацией.  
- Если ваш orange pi 5 ultra (или любой другой одноплатный ПК) имеет более 4 ГБ оперативной памяти, то необходимо отключить RGA2, так как если планировщик перенаправит задание обработки изображения с RGA3 на RGA2, то система зависнет.

### **Инструкция по отключению RGA2**
##### 1. Проверьте текущие настройки RGA
```
dmesg | grep rga
```
Пример вывода
>
	[   28.088586] rockchip-pm-domain fd8d8000.power-management:power-controller: Looking up rga30-supply from device tree
	[   28.088613] rockchip-pm-domain fd8d8000.power-management:power-controller: Looking up rga30-supply property in node /power-management@fd8d8000/power-controller failed
	[   28.088986] rockchip-pm-domain fd8d8000.power-management:power-controller: Looking up rga31-supply from device tree
	[   28.089008] rockchip-pm-domain fd8d8000.power-management:power-controller: Looking up rga31-supply property in node /power-management@fd8d8000/power-controller failed
	[   28.769168] rga3 fdb60000.rga: Adding to iommu group 2
	[   28.769454] rga3 fdb60000.rga: probe successfully, irq = 41, hw_version:3.0.76831
	[   28.769522] rga3 fdb70000.rga: Adding to iommu group 3
	[   28.769704] rga3 fdb70000.rga: probe successfully, irq = 42, hw_version:3.0.76831
	[   28.770092] rga2 fdb80000.rga: probe successfully, irq = 104, hw_version:3.2.63318
	[   28.770166] rga_iommu: IOMMU binding successfully, default mapping core[0x1]
	[   28.770239] rga: Module initialized. v1.3.4

##### 2. Проверьте пути расположения файлов `dtb`
```
cat /boot/extlinux/extlinux.conf
```
###### Пример вывода
>
	## /boot/extlinux/extlinux.conf
	##
	## IMPORTANT WARNING
	##
	## The configuration of this file is generated automatically.
	## Do not edit this file manually, use: u-boot-update
	
	default l0
	menu title U-Boot menu
	prompt 1
	timeout 20
	
	
	label l0
		menu label Ubuntu 24.04.1 LTS 6.1.0-1025-rockchip
		linux /boot/vmlinuz-6.1.0-1025-rockchip
		initrd /boot/initrd.img-6.1.0-1025-rockchip
		fdtdir /lib/firmware/6.1.0-1025-rockchip/device-tree/
		
		append root=UUID=5a0f61f0-da0c-42d9-b3c5-ae352b724b38 rootwait rw console=ttyS2,1500000 console=tty1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory quiet splash plymouth.ignore-serial-consoles
	
	label l0r
		menu label Ubuntu 24.04.1 LTS 6.1.0-1025-rockchip (rescue target)
		linux /boot/vmlinuz-6.1.0-1025-rockchip
		initrd /boot/initrd.img-6.1.0-1025-rockchip
		fdtdir /lib/firmware/6.1.0-1025-rockchip/device-tree/
		append root=UUID=5a0f61f0-da0c-42d9-b3c5-ae352b724b38 rootwait rw console=ttyS2,1500000 console=tty1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory splash plymouth.ignore-serial-consoles single


##### 3. Перейдите в папку с драйверами
```
cd /lib/firmware/6.1.0-1025-rockchip/device-tree
ls
```
##### 4. Найдите файл с именем `rk3588-orangepi-5-ultra.dtb` (возможно другое имя файла, если плата отличается)
##### 5. Декомпилируйте DTB → DTS
```
sudo dtc -I dtb -O dts -o orangepi-5-ultra.dts rockchip/rk3588s-orangepi-5-ultra.dtb
```
##### 6. Найдите номера строк, содержащих настройки RGA, в файле orangepi-5-ultra.dts
```
grep -n "rga" orangepi-5-ultra.dts
```
##### 7. Открыть DTS для редактирования.
```
sudo nano -l orangepi-5-ultra.dts
```
##### 8. Перейти к нужной строке с сочетание клавиш `Ctrl`+`/` и введите нужную строку, например `3888`.
###### Пример вывода.
>
	3888         rga@fdb80000 {
	 3889                 compatible = "rockchip,rga2_core0";
	 3890                 reg = <0x00 0xfdb80000 0x00 0x1000>;
	 3891                 interrupts = <0x00 0x74 0x04>;
	 3892                 interrupt-names = "rga2_irq";
	 3893                 clocks = <0x02 0x1b7 0x02 0x1b6 0x02 0x1b8>;
	 3894                 clock-names = "aclk_rga2\0hclk_rga2\0clk_rga2";
	 3895                 power-domains = <0x06 0x15>;
	 3896                 status = "okay"; # заменить на "disabled"
	 3897                 phandle = <0x265>;
	 3898         };

Замените `status = "okay";` на `status = "disabled";`
Сохраните изменения командой `Ctrl`+`o` и выйдите из редактора `Ctrl`+`x`
##### 9. Перекомпилируйте DTS → DTB
```
sudo dtc -I dts -O dtb -o rk3588-orangepi-5-ultra.dtb orangepi-5-ultra.dts
```
##### 10. Сделайте резервную копию оригинального DTB!
```
sudo cp rockchip/rk3588-orangepi-5-ultra.dtb rockchip/rk3588-orangepi-5-ultra.dtb.bak
```
##### 11. Замените текущий DTB:
```
sudo mv rk3588-orangepi-5-ultra.dtb rockchip/rk3588-orangepi-5-ultra.dtb
```
##### 12. Обновить initramfs и перезагрузить
```
sudo update-initramfs -u
sudo reboot
```
##### 13. После перезагрузки проверьте доступные блоки RGA
```
dmesg | grep rga
```
Пример вывода
>
	[    5.946000] rockchip-pm-domain fd8d8000.power-management:power-controller: Looking up rga30-supply from device tree
	[    5.946026] rockchip-pm-domain fd8d8000.power-management:power-controller: Looking up rga30-supply property in node /power-management@fd8d8000/power-controller failed
	[    5.946420] rockchip-pm-domain fd8d8000.power-management:power-controller: Looking up rga31-supply from device tree
	[    5.946441] rockchip-pm-domain fd8d8000.power-management:power-controller: Looking up rga31-supply property in node /power-management@fd8d8000/power-controller failed
	[   23.078653] rga3 fdb60000.rga: Adding to iommu group 2
	[   23.078946] rga3 fdb60000.rga: probe successfully, irq = 51, hw_version:3.0.76831
	[   23.079009] rga3 fdb70000.rga: Adding to iommu group 3
	[   23.079183] rga3 fdb70000.rga: probe successfully, irq = 52, hw_version:3.0.76831
	[   23.079458] rga_iommu: IOMMU binding successfully, default mapping core[0x1]
	[   23.079584] rga: Module initialized. v1.3.4

